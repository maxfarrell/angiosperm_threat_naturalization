---
title: "Threatened and Naturalized plants across Angiosperm Families"
author: "Maxwell J. Farrell"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  html_document:
    highlight: default
    toc: yes
    toc_depth: 3
    toc_float: true
    theme: yeti
urlcolor: blue
---

<!-- knit with 
Rscript -e "rmarkdown::render('threat_naturalized_plant_families_imputed.Rmd')"
 -->

# Set up

## Packages 

```{r loading packages, echo=T, message=F, warning=F}
require(tidyr)
require(dplyr)
require(magrittr)
require(ggplot2)
require(bayesplot)
require(ape)
require(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
require(brms)
require(ggmcmc)
require(knitr)
require(phytools)
require(cowplot)
require(RColorBrewer)
require(ggtree)
require(car)
require(xtable)
require(phytools)

# Functions
nrmse <-  function(obs, pred, type = "sd") {
  
    squared_sums <- sum((obs - pred)^2)
    mse <- squared_sums/length(obs)
    rmse <- sqrt(mse)
    if (type == "sd") nrmse <- rmse/sd(obs)
    if (type == "mean") nrmse <- rmse/mean(obs)
    if (type == "maxmin") nrmse <- rmse/ (max(obs) - min(obs))
    if (type == "iq") nrmse <- rmse/ (quantile(obs, 0.75) - quantile(obs, 0.25))
    if (!type %in% c("mean", "sd", "maxmin", "iq")) message("Wrong type!")
    nrmse <- round(nrmse, 3)
 return(nrmse)
    
}

rmse <- function(obs, pred){
    sqrt(mean((obs - pred)^2))
}

inv_logit <- function(x) {exp(x)/(1+exp(x))}


```

## Loading data

```{r loading data, echo=T, message=F, warning=F, results='hide'}

data <- read.csv("./sp.rare.inv.csv", as.is=F)

# one family has more rare species than species
data[data$rare>data$species,]

# increasing species by 1 to match
data$species[data$family=="Metteniusaceae"] <- 8

nrow(data)# 407
range(data$vetted)
nrow(data[data$vetted>0,])# 260

# creating column for woodiness
data$woodiness <- data$herbaceous + data$woody + data$variable

# fixing typo in names 
names(data)[names(data)%in%"dmonoecious"] <- "monoecious"

### Zanne tree & generating tree representing families
tree <- read.tree("./Vascular_Plants_rooted.dated.tre")
spec_fam <- read.csv("./spec.fam.csv", as.is=T)
tree <- drop.tip(tree, setdiff(tree$tip.label,as.character(spec_fam$sp)))
lookup <- setNames(spec_fam$family, spec_fam$sp)
tree$tip.label <- as.character(lookup[tree$tip.label])

# Getting new family age
min_above_zero <- function(x){

  if (length(x)>1) {
    min(x[x>0])
  } else {0}

}

# Calculate family age (may be influenced by families missing from the tree)
coph <- cophenetic(tree)

fam_age <- sapply(rownames(coph), function(fam) 
          min_above_zero(coph[rownames(coph)%in%fam,])
          ) 

new_ages <- data.frame(family=names(fam_age), new_age=as.numeric(fam_age)/2)
new_ages %<>% arrange(family)
data <- left_join(data,new_ages)

# There are some ages of NA (not in tree?)
# Remove these
data <- data[!is.na(data$new_age),]

# Calculating simple diversification metric - log(N+1)/age
data$diversification <- with(data, log(species)/new_age)

# creating another family level variable (for non-phylogenetic family level effects)
data$family_name <- data$family

# These families we have data for, but are not in tree
setdiff(data$family, tree$tip.label) 
# none

# Identify families in tree with no data
setdiff(tree$tip.label, data$family)
# Centrolepidaceae

# remove missing families in data
data <- data[data$family%in%tree$tip.label,]

# remove families in tree with no data 
tree <- drop.tip(tree, setdiff(tree$tip.label, as.character(data$family)))

# phylogenetic correlation structure
phy_cov <- vcv(tree, corr=TRUE)

```

```{r raw_data_plot, echo=F, eval=F}

# Order dat to match tree tip labels
dat <- data[match(tree$tip.label,data$family),]

# threat
threat <- dat$rare/dat$vetted
names(threat) <- tree$tip.label
# remove NaN families
threat <- threat[!is.nan(threat)]
# remove these from dat
dat <- dat[dat$family %in% names(threat),]

# prune tree
p_tree <- drop.tip(tree, setdiff(tree$tip.label, as.character(dat$family)))
dat <- dat[match(p_tree$tip.label,dat$family),]

# naturalization
nat <- dat$Naturalised/dat$species
names(nat) <- p_tree$tip.label

# adding contmap of diversification
div <- dat$diversification
names(div) <- p_tree$tip.label

# Creating diversity mapping
obj<-contMap(p_tree,div,plot=FALSE)

##############
# https://guangchuangyu.github.io/2016/10/facet_plot-a-general-solution-to-associate-data-with-phylogenetic-tree/

cols<-c("#88b7c5","#a36666")

fit <- phytools::fastAnc(p_tree,div,vars=TRUE,CI=TRUE)
td <- data.frame(node = nodeid(p_tree, names(div)),
               trait = div)
nd <- data.frame(node = names(fit$ace), trait = fit$ace)
d <- rbind(td, nd)
d$node <- as.numeric(d$node)

p <- ggtree(p_tree, aes(color=d$trait), layout = 'rectangular', 
        ladderize = FALSE, size=0.4) + theme_tree2(legend.position = c(.08, .85),legend.title=element_text(size=8),strip.background =element_rect(fill="white"),panel.border = element_rect(colour = "white")) +
      scale_colour_viridis_c(direction=-1, name="Diversification rate")
# p

d2 <- data.frame(id=p_tree$tip.label,threat,nat)

p <- p %<+% d2

p2 <- facet_plot(p, panel = 'Proportion threatened', data = d2, 
                geom = ggstance::geom_barh, 
                aes(x = -threat), 
                stat='identity',
                color=cols[2], fill=cols[2], width=0.03)

# p2 # Don't know how to flip axis only on the second plot... will remove negative signs in Inkscape

p3 <- facet_plot(p2, panel = 'Proportion naturalized', data = d2, 
                geom = ggstance::geom_barh, 
                aes(x = nat), 
                stat='identity',
                color=cols[1],fill=cols[1], width=0.03) #+ scale_x_reverse()

p3

# p4 <- p3 + facet_grid(.~panel, scale="free_x") + scale_y_continuous(expand = c(0,3)) + scale_x_continuous(expand = c(0,0.04))

# ggsave("./plots_tables/div_threatVetted_nat_plot_2.pdf",p4, height=6,width=8)

```

## Transforming predictors

```{r transforming predictors}

# Code for scale and unscale with mean=0 sd=0.5 (following Gelman 2008)
scale_half <- function(x){
  return( (x-mean(x)) * 0.5/sd(x))
}

unscale_half <- function(x,original){
    x*sd(original)*2 + mean(original)  
}

# Converting species.hybrids to proportion
data$species.hybrids <- data$species.hybrids/data$species

# Scaling continuous predictors
data$new_age_scaled <- scale_half(log(data$new_age))
data$species_scaled <- scale_half(log(data$species))
data$diversification_scaled <- scale_half(log(data$diversification+1))
data$Naturalised_scaled <- scale_half(log(data$Naturalised+1))
data$species.hybrids <- scale_half(data$species.hybrids)

# Subsetting to IUCN vetted species (for rarity models)
data_vetted <- data[data$vetted>0,]
tree_vetted <- drop.tip(tree, setdiff(tree$tip.label, as.character(data_vetted$family)))
phy_cov_vetted <- vcv(tree_vetted, corr=TRUE)

```

## Assessing multicollinearity

```{r vifs}

vif(lm(rare ~ Naturalised_scaled + diversification_scaled + new_age_scaled, data=data_vetted))

vif(lm(rare ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, data=data_vetted))

vif(lm(rare ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, data=data))

```
&nbsp;
&nbsp;

# Exploration of priors

Visualization of brms default priors (blue) compared to custom priors (yellow) inspired by McElreath's book Statistical Rethinking.

Priors for the slope parameters:

```{r prior_predict_beta, echo=TRUE, eval=TRUE}

prior <- runif(n=10000, min=-100, max=100) # brms default is actually -Inf to +Inf
p <- inv_logit(prior)
prior2 <- rnorm(n=10000, 0, 1.5) # McElreath
p2 <- inv_logit(prior2)

plot(density(p, adj=0.1), xlim=c(0,1), col="#56B4E9", main="", xlab=expression(paste("inv_logit (",beta,")")))
lines(density(p2, adj=0.1), col="#E69F00")

```

```{r prior_plot_1, echo=F, eval=F}
pdf("./plots_tables/priors_beta.pdf", width=5, height=4)
plot(density(p, adj=0.1), xlim=c(0,1), col="#56B4E9", main="", xlab=expression(paste("inv_logit (",beta,")")))
lines(density(p2, adj=0.1), col="#E69F00")
dev.off()

```

The default improper uniform prior used by brms is flat on the log-odd scale, so when converted to the probabilty scale, puts excess mass near 0 and 1. A Normal(0, 1.5) prior is more reasonable, having a flatter distribution with a mode at 0.5 on the probablity scale. 


Priors for the family-level variance parameters:

```{r prior_predict-sigma, echo=TRUE, eval=TRUE}

prior <- rstudent_t(n=10000, df=3, mu=0, sigma=10) # brms default
prior <- prior[prior>0]
# p <- inv_logit(prior)

prior2 <- rnorm(n=10000, 0, 1) # McElreath
prior2 <- prior2[prior2>0]
# p2 <- inv_logit(prior2)

plot(density(prior2, adj=0.1), xlim=c(0,10), col="#E69F00", main="", xlab=expression(paste(sigma)))
lines(density(prior, adj=0.1), col="#56B4E9")

```

```{r prior_plot_2, echo=F, eval=T}
pdf("./plots_tables/priors_sigma.pdf", width=5, height=4)
plot(density(prior2, adj=0.1), xlim=c(0,10), col="#E69F00", main="", xlab=expression(paste(sigma)))
lines(density(prior, adj=0.1), col="#56B4E9")
dev.off()

```

The brms prior is extremely long tailed. Considering we are fitting a non-linear model in which changes in log-odds over over 4 have a diminishing influence due to the ceiling effect of the binomial distribution. With this in mind, a prior of Normal(0,1) constrains the posterior to a more realistic range, and is likely to improve sampling efficiency.


# Rarity models  (with IUCN evaluated species)

## Simple rarity model - brms default priors

```{r rare_nat_vetted, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_naturalized_10k.rds")) {

  vet_rare_nat <- brm(rare | trials(vetted) ~ Naturalised_scaled + diversification_scaled + new_age_scaled +  (1|family) + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=4)

  saveRDS(vet_rare_nat, "./vet_rare_naturalized_10k.rds")

} else { vet_rare_nat <- readRDS("./vet_rare_naturalized_10k.rds")}

# prior_summary(vet_rare_nat, all=TRUE)
# Default if for  b coefficients to have improper priors

outcome <- summary(vet_rare_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Number of naturalized species","Diversification rate","Family age","SD brownian effects","SD family specific effects")

vet_rare_nat_plot <- stanplot(vet_rare_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))

vet_rare_nat_plot

# pdf("./plots_tables/vet_rare_nat_plot.pdf", width=5, height=4)
# vet_rare_nat_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_nat.tex")

##Posterior predictive checks
pp_vet_rare_nat <- brms::posterior_predict(vet_rare_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nat$data$rare, pp_vet_rare_nat[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_vet_rare_nat <- apply(pp_vet_rare_nat, 1, function(x) nrmse(pred=x,obs=vet_rare_nat$data$rare, type="iq"))
mean(nrmse_vet_rare_nat)
sd(nrmse_vet_rare_nat)

# RMSE
rmse_vet_rare_nat <- apply(pp_vet_rare_nat, 1, function(x) rmse(pred=x,obs=vet_rare_nat$data$rare))
mean(rmse_vet_rare_nat)
sd(rmse_vet_rare_nat)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare_nat, hyp, class = NULL))

```

## Simple rarity model - prior / posterior plots

```{r prior_posterior_simple_brms, echo=T, eval=T}
# Plotting influence of prior on posterior for a beta parameter
# on the log-odds scale

tibble(x = seq(from = -10, to = 10, by = .01)) %>%   

  ggplot() +
  # the prior
  # improper uniform prior restricted to (-10,10) to aid visualization
  geom_ribbon(aes(x = x, ymin = 0, ymax = dunif(x,-10,10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_nat),
               aes(x = b_new_age_scaled), 
               fill = "#56B4E9", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(-5, 5)) +
  labs(x="Beta Age (brms priors)", y="Density") + 
  theme_bw() -> prior_post_1_beta

prior_post_1_beta

# Plotting influence of prior on posterior for a sigma parameter

# SD Family Effect
tibble(x = seq(from = 0, to = 6, by = .01)) %>%   
  ggplot() +
  # the prior
  geom_ribbon(aes(x = x, ymin = 0, ymax = dstudent_t(x, df=3, mu=0, sigma=10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_nat),
               aes(x = sd_family_name__Intercept), 
               fill = "#56B4E9", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(0, 5)) +
  labs(x="SD Family Effects (brms priors)", y="Density") + 
  theme_bw() -> prior_post_1_sigma

prior_post_1_sigma


```

```{r plot_prior_post_simple_brms, eval=F, echo=F}

ggsave("./plots_tables/prior_post_simple_beta_brms.pdf", prior_post_1_beta , height=4,width=5)

ggsave("./plots_tables/prior_post_simple_sigma_brms.pdf", prior_post_1_sigma , height=4,width=5)

```



## Simple rarity model - custom priors (based on McElreath)

```{r rare_nat_vetted_p2, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_naturalized_p2_10k.rds")) {

  vet_rare_nat_p2 <- brm(rare | trials(vetted) ~ Naturalised_scaled + diversification_scaled + new_age_scaled +  (1|family) + (1|family_name), 
    dat=data_vetted, family=binomial(),

    # custom priors based on McElreath
    prior = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1.5), class = b),
                prior(normal(0, 1), class = sd)),

    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=4)

  saveRDS(vet_rare_nat_p2, "./vet_rare_naturalized_p2_10k.rds")

} else { vet_rare_nat_p2 <- readRDS("./vet_rare_naturalized_p2_10k.rds")}

# prior_summary(vet_rare_nat_p2, all=TRUE)

outcome <- summary(vet_rare_nat_p2$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Number of naturalized species","Diversification rate","Family age","SD brownian effects","SD family specific effects")

vet_rare_nat_p2_plot <- stanplot(vet_rare_nat_p2, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))

vet_rare_nat_p2_plot

# pdf("./plots_tables/vet_rare_nat_p2_plot.pdf", width=5, height=4)
# vet_rare_nat_p2_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_nat_p2.tex")

##Posterior predictive checks
pp_vet_rare_nat_p2 <- brms::posterior_predict(vet_rare_nat_p2)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nat_p2$data$rare, pp_vet_rare_nat_p2[1:50, ]) + scale_x_continuous(trans="log1p")


# NRMSE
nrmse_vet_rare_nat_p2 <- apply(pp_vet_rare_nat_p2, 1, function(x) nrmse(pred=x,obs=vet_rare_nat_p2$data$rare, type="iq"))
mean(nrmse_vet_rare_nat_p2)
sd(nrmse_vet_rare_nat_p2)

# RMSE
rmse_vet_rare_nat_p2 <- apply(pp_vet_rare_nat_p2, 1, function(x) rmse(pred=x,obs=vet_rare_nat_p2$data$rare))
mean(rmse_vet_rare_nat_p2)
sd(rmse_vet_rare_nat_p2)


# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare_nat_p2, hyp, class = NULL))

```


```{r prior_posterior_custom_simple, echo=T, eval=T}


```


```{r prior_posterior_simple_custom, echo=T, eval=T}
# Plotting influence of prior on posterior for a beta parameter
# on the log-odds scale

tibble(x = seq(from = -10, to = 10, by = .01)) %>%   
  ggplot() +
  # the prior
  geom_ribbon(aes(x = x, ymin = 0, ymax = dnorm(x,0,1.5)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_nat_p2),
               aes(x = b_new_age_scaled), 
               fill = "#E69F00", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(-5, 5)) +
  labs(x="Beta Age - custom priors", y="Density") + 
  theme_bw() -> prior_post_2_beta

prior_post_2_beta

# Plotting influence of prior on posterior for a sigma parameter

# SD Family Effect
tibble(x = seq(from = 0, to = 6, by = .01)) %>%   
  ggplot() +
  # the prior
  geom_ribbon(aes(x = x, ymin = 0, ymax = dnorm(x, 0,1)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_nat_p2),
               aes(x = sd_family_name__Intercept), 
               fill = "#E69F00", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(0, 5)) +
  labs(x="SD Family Effects (brms priors)", y="Density") + 
  theme_bw() -> prior_post_2_sigma

prior_post_2_sigma


```

```{r plot_prior_post_simple_custom, eval=F, echo=F}

ggsave("./plots_tables/prior_post_simple_beta_custom.pdf", prior_post_2_beta , height=4,width=5)

ggsave("./plots_tables/prior_post_simple_sigma_custom.pdf", prior_post_2_sigma , height=4,width=5)

```




## Full rarity model (IUCN vetted species) - brms default priors

```{r frac_rare_vetted_brms, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_10k.rds")) {

  vet_rare <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.98,max_treedepth=13))
    # no divergent transitions

  saveRDS(vet_rare, "./vet_rare_10k.rds")

} else { vet_rare <- readRDS("./vet_rare_10k.rds")}

# prior_summary(vet_rare, all=FALSE)

outcome <- summary(vet_rare$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age","Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

vet_rare_plot <- stanplot(vet_rare, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_plot

# pdf("./plots_tables/vet_rare_plot.pdf", width=5, height=4)
# vet_rare_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare.tex")

##Posterior predictive checks
# first make posterior predictions
pp_rare <- brms::posterior_predict(vet_rare)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_vet <- apply(pp_rare, 1, function(x) nrmse(pred=x,obs=vet_rare$data$rare, type="iq"))
mean(nrmse_vet)
sd(nrmse_vet)

# RMSE
rmse_vet <- apply(pp_rare, 1, function(x) rmse(pred=x,obs=vet_rare$data$rare))
mean(rmse_vet)
sd(rmse_vet)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare, hyp, class = NULL))
# plot(hyp)

```


## Full rarity model (IUCN vetted species) - brms prior / posterior plots

```{r prior_posterior_full_brms, echo=T, eval=T}
# Plotting influence of prior on posterior for a beta parameter
# on the log-odds scale

tibble(x = seq(from = -10, to = 10, by = .01)) %>%   
  ggplot() +
  # the prior
  # improper uniform prior restricted to (-10,10) to aid visualization
  geom_ribbon(aes(x = x, ymin = 0, ymax = dunif(x,-10,10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare),
               aes(x = b_new_age_scaled), 
               fill = "#56B4E9", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(-5, 5)) +
  labs(x="Beta Age (brms priors)", y="Density") + 
  theme_bw() -> prior_post_3_beta

prior_post_3_beta

# Plotting influence of prior on posterior for a sigma parameter

# SD Family Effect
tibble(x = seq(from = 0, to = 6, by = .01)) %>%   
  ggplot() +
  # the prior
  geom_ribbon(aes(x = x, ymin = 0, ymax = dstudent_t(x, df=3, mu=0, sigma=10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare),
               aes(x = sd_family_name__Intercept), 
               fill = "#56B4E9", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(0, 5)) +
  labs(x="SD Family Effects (brms priors)", y="Density") + 
  theme_bw() -> prior_post_3_sigma

prior_post_3_sigma


```

```{r plot_prior_post_full_brms, eval=F, echo=F}

ggsave("./plots_tables/prior_post_full_beta_brms.pdf", prior_post_3_beta , height=4,width=5)

ggsave("./plots_tables/prior_post_full_sigma_brms.pdf", prior_post_3_sigma , height=4,width=5)

```



## Full rarity model (IUCN vetted species) - custom priors (based on McElreath)

```{r frac_rare_vetted_custom, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_p2_10k.rds")) {

  vet_rare_p2 <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 

    # custom priors based on McElreath
    prior = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1.5), class = b),
                prior(normal(0, 1), class = sd)),

    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.98,max_treedepth=13))

  # no divergent transitions

  saveRDS(vet_rare_p2, "./vet_rare_p2_10k.rds")

} else { vet_rare_p2 <- readRDS("./vet_rare_p2_10k.rds")}

# prior_summary(vet_rare_p2, all=FALSE)

outcome <- summary(vet_rare_p2$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age","Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

vet_rare_p2_plot <- stanplot(vet_rare_p2, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_p2_plot

# pdf("./plots_tables/vet_rare_p2_plot.pdf", width=5, height=4)
# vet_rare_p2_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_p2.tex")

##Posterior predictive checks
# first make posterior predictions
pp_rare <- brms::posterior_predict(vet_rare_p2)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_p2$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_vet <- apply(pp_rare, 1, function(x) nrmse(pred=x,obs=vet_rare_p2$data$rare, type="iq"))
mean(nrmse_vet)
sd(nrmse_vet)

# RMSE
rmse_vet <- apply(pp_rare, 1, function(x) rmse(pred=x,obs=vet_rare_p2$data$rare))
mean(rmse_vet)
sd(rmse_vet)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare_p2, hyp, class = NULL))
# plot(hyp)
```


## Full rarity model (IUCN vetted species) - custom prior / posterior plots

```{r prior_posterior_full_custom, echo=T, eval=T}
# Plotting influence of prior on posterior for a beta parameter
# on the log-odds scale

tibble(x = seq(from = -10, to = 10, by = .01)) %>%   
  ggplot() +
  # the prior
  # improper uniform prior restricted to (-10,10) to aid visualization
  geom_ribbon(aes(x = x, ymin = 0, ymax = dunif(x,-10,10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_p2),
               aes(x = b_new_age_scaled), 
               fill = "#E69F00", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(-5, 5)) +
  labs(x="Beta Age (brms priors)", y="Density") + 
  theme_bw() -> prior_post_4_beta

prior_post_4_beta

# Plotting influence of prior on posterior for a sigma parameter

# SD Family Effect
tibble(x = seq(from = 0, to = 6, by = .01)) %>%   
  ggplot() +
  # the prior
  geom_ribbon(aes(x = x, ymin = 0, ymax = dstudent_t(x, df=3, mu=0, sigma=10)),
              fill = "#A9A9A9", alpha = 1/2) +
  # the posterior
  geom_density(data = posterior_samples(vet_rare_p2),
               aes(x = sd_family_name__Intercept), 
               fill = "#E69F00", size = 0, alpha = 1/2) +
  scale_y_continuous() +
  coord_cartesian(xlim = c(0, 5)) +
  labs(x="SD Family Effects (brms priors)", y="Density") + 
  theme_bw() -> prior_post_4_sigma

prior_post_4_sigma


```

```{r plot_prior_post_full_custom, eval=F, echo=F}

ggsave("./plots_tables/prior_post_full_beta_custom.pdf", prior_post_4_beta , height=4,width=5)

ggsave("./plots_tables/prior_post_full_sigma_custom.pdf", prior_post_4_sigma , height=4,width=5)

```


# Naturalized model

```{r frac_nat, echo=TRUE, eval=TRUE}

if (!file.exists("./fit_nat_10k.rds")) {

  fit_nat <- brm(Naturalised | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=11))

  saveRDS(fit_nat, "./fit_nat_10k.rds")

} else { fit_nat <- readRDS("./fit_nat_10k.rds")}

outcome <- summary(fit_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

fit_nat_plot <- stanplot(fit_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))+ ggtitle("Proportion of naturalized species")

fit_nat_plot

# pdf("./plots_tables/fit_nat_plot.pdf", width=5, height=4)
# fit_nat_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/fit_nat.tex")

##Posterior predictive checks
pp_nat <- brms::posterior_predict(fit_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_nat$data$Naturalised, pp_nat[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_nat <- apply(pp_nat, 1, function(x) nrmse(pred=x,obs=fit_nat$data$Naturalised, type="iq"))
mean(nrmse_nat)
sd(nrmse_nat)

# RMSE
rmse_nat <- apply(pp_nat, 1, function(x) rmse(pred=x,obs=fit_nat$data$Naturalised))
mean(rmse_nat)
sd(rmse_nat)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(fit_nat, hyp, class = NULL))


```


```{r fig.width=6, fig.height=5, paper_forest_plots}

# simplified threat model
outcome <- summary(vet_rare_nat$fit, prob=c(0.1,0.9))
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]
to_print <- data.frame(to_print)

names1 <- c("Number of naturalized species","Diversification rate","Family age","SD Brownian effects","SD family specific effects")
to_print$variable <- as.factor(names1)


p <-  ggplot(to_print, aes(x=variable, y=mean)) + scale_x_discrete(limits = rev(    levels(to_print$variable))) +
      geom_pointrange(aes(ymin=X10., ymax=X90.)) + coord_flip()  + 
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
      geom_hline(yintercept = 0) + xlab("") + ylab("") +
      theme(legend.title = element_blank()) 
p

# ggsave("./plots_tables/threat_nat_forest.pdf", p , height=3,width=6)
# ggsave("./plots_tables/threat_nat_forest.png", p , height=3,width=6)


# combined Threat and Naturalized
threat_out <- summary(vet_rare$fit, prob=c(0.1,0.9))
threat_out <- threat_out$summary[grep("^[sd,b]_*",rownames(threat_out$summary)),]
threat_out <- threat_out[-1,]
threat_out <- data.frame(threat_out)
threat_out$group <- rev(letters[1:nrow(threat_out)])
threat_out$model <- "Threatened"

nat_out <- summary(fit_nat$fit, prob=c(0.1,0.9))
nat_out <- nat_out$summary[grep("^[sd,b]_*",rownames(nat_out$summary)),]
nat_out <- nat_out[-1,]
nat_out <- data.frame(nat_out)
nat_out$group <- rev(letters[1:nrow(nat_out)])
nat_out$model <- "Naturalized"

labels=c("Diversification rate","Family age","Variation in growth form","Herbaceous","Climate range variability","Species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual seed production","Fleshy fruits","Animal pollination","SD Brownian effects","SD family specific effects")

threat_out$variable <- labels
nat_out$variable <- labels

coefs <- rbind(threat_out, nat_out)

coefs$overlap <- c( "n","n","n","n","n","n","y","y","y","y","y","n","n","n",
                    "n","n","y","n","n","n","y","y","y","n","y","n","n","n")

coefs$opposite <- c("y","y","n","y","y","y","n","n","n","n","n","y","n","n",
                    "y","y","n","y","y","y","n","n","n","n","n","y","n","n")

coefs$both <- c("ny","ny","nn","ny","ny","ny","yn","yn","yn","yn","yn","ny","nn","nn",
                "ny","ny","yn","ny","ny","ny","yn","yn","yn","nn","yn","ny","nn","nn")

labels<-rev(labels)

cols<-c("#88b7c5","#a36666")

p2 <- ggplot(coefs, aes(x=group, y=mean, color=model)) + scale_shape_manual(values=c(17,15,17)) + scale_alpha_manual(values=c(1,1,0.4)) +
  geom_pointrange(aes(ymin=X10., ymax=X90.,shape=both,alpha=both)) + coord_flip()  + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  geom_hline(yintercept = 0)  + xlab("") + ylab("") + theme(legend.position = "none") +
theme(legend.title = element_blank()) + scale_x_discrete(labels=labels) + guides(shape = FALSE, size = FALSE) + scale_colour_manual(values=cols)

p2             

# ggsave("./plots_tables/combined_forest.pdf", p2 , height=5,width=6)
# ggsave("./plots_tables/combined_forest.png", p2 , height=5,width=6)


```


```{r, fig.width=8, fig.height=8, eval=F, echo=F}
# Phylogenetic effects plots (IUCN vetted full rarity model)

# Combined plot - rarity

# Extract species level effects
ranef_phy <- ranef(vet_rare)$family
ranef_binom <- ranef(vet_rare)$family_name
ranef_spec <- ranef_phy + ranef_binom

ranef_phy <- as.data.frame(unlist(ranef_phy))
ranef_binom <- as.data.frame(unlist(ranef_binom))
ranef_spec <- as.data.frame(unlist(ranef_spec))

# re-order efects to match tree
tree_small <- drop.tip(tree, setdiff(tree$tip.label, rownames(ranef_spec)))
ranef_phy <- ranef_phy[tree_small$tip.label,]
ranef_binom <- ranef_binom[tree_small$tip.label,]
ranef_spec <- ranef_spec[tree_small$tip.label,]

# Plot the beside the phylogeny
cols <- c("#7570b3","#d95f02")

# pdf("./plots_tables/phylo_rarity_barplot_combined.pdf", width=30, height=10)
par(mfrow=c(1,3))

# Brownian phylogenetic effects
phy_effects <- abs(ranef_phy$Estimate.Intercept)
names(phy_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=phy_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

legend(-320,320,legend=c("Positive","Negative"),
       col=cols,lty=1, lwd=6, cex=1.3, box.lwd=0, box.col="white")


# Family specific effects (non-brownian)

binom_effects <- abs(ranef_binom$Estimate.Intercept)
names(binom_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=binom_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

# Family total Brownian + Family Specific

fam_effects <- abs(ranef_spec$Estimate.Intercept)
names(fam_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=fam_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

# dev.off()


# Combined plot - naturalization

# Extract species level effects
ranef_phy <- ranef(fit_nat)$family
ranef_binom <- ranef(fit_nat)$family_name
ranef_spec <- ranef_phy + ranef_binom

ranef_phy <- as.data.frame(unlist(ranef_phy))
ranef_binom <- as.data.frame(unlist(ranef_binom))
ranef_spec <- as.data.frame(unlist(ranef_spec))

# re-order efects to match tree
tree_small <- drop.tip(tree, setdiff(tree$tip.label, rownames(ranef_spec)))
ranef_phy <- ranef_phy[tree_small$tip.label,]
ranef_binom <- ranef_binom[tree_small$tip.label,]
ranef_spec <- ranef_spec[tree_small$tip.label,]

# Plot the beside the phylogeny
cols <- c("#7570b3","#d95f02")

# pdf("./plots_tables/phylo_naturalization_barplot_combined.pdf", width=30, height=10)
par(mfrow=c(1,3))

# Brownian phylogenetic effects

phy_effects <- abs(ranef_phy$Estimate.Intercept)
names(phy_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=phy_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

legend(-320,320,legend=c("Positive","Negative"),
       col=cols,lty=1, lwd=6, cex=1.3, box.lwd=0, box.col="white")


# Family specific effects (non-brownian)

binom_effects <- abs(ranef_binom$Estimate.Intercept)
names(binom_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=binom_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

fam_effects <- abs(ranef_spec$Estimate.Intercept)
names(fam_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=fam_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

# dev.off()


```

# Sensitivity analyses

## Full rarity model: no family level effects

```{r frac_rare_nofam, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_nofam_10k.rds")) {

  vet_rare_nofam <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4,
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_nofam, "./vet_rare_nofam_10k.rds")

} else { vet_rare_nofam <- readRDS("./vet_rare_nofam_10k.rds")}

outcome <- summary(vet_rare_nofam$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated")

vet_rare_nofam_plot <- stanplot(vet_rare_nofam, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_nofam_plot

# pdf("./plots_tables/vet_rare_nofam_plot.pdf", width=5, height=4)
# vet_rare_nofam_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_nofam.tex")


##Posterior predictive checks
# first make posterior predictions
pp_rare_nofam <- brms::posterior_predict(vet_rare_nofam)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nofam$data$rare, pp_rare_nofam[1:50, ]) + scale_x_continuous(trans="log1p")


# NRMSE
nrmse_rare_nofam <- apply(pp_rare_nofam, 1, function(x) nrmse(pred=x,obs=vet_rare_nofam$data$rare, type="iq"))
mean(nrmse_rare_nofam)
sd(nrmse_rare_nofam)

# RMSE
rmse_rare_nofam <- apply(pp_rare_nofam, 1, function(x) rmse(pred=x,obs=vet_rare_nofam$data$rare))
mean(rmse_rare_nofam)
sd(rmse_rare_nofam)

```

## Full rarity model: only non-brownian family effects

```{r frac_rare_nophylo, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_nophylo_10k.rds")) {

  vet_rare_nophylo <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4,
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_nophylo, "./vet_rare_nophylo_10k.rds")

} else { vet_rare_nophylo <- readRDS("./vet_rare_nophylo_10k.rds")}

outcome <- summary(vet_rare_nophylo$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD family specific effects")

vet_rare_nophylo_plot <- stanplot(vet_rare_nophylo, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_nophylo_plot

# pdf("./plots_tables/vet_rare_nophylo_plot.pdf", width=5, height=4)
# vet_rare_nophylo_plot + ggtitle("")
# dev.off()


rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_nophylo.tex")


##Posterior predictive checks
pp_rare_nophylo <- brms::posterior_predict(vet_rare_nophylo)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nophylo$data$rare, pp_rare_nophylo[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_rare_nophylo <- apply(pp_rare_nophylo, 1, function(x) nrmse(pred=x,obs=vet_rare_nophylo$data$rare, type="iq"))
mean(nrmse_rare_nophylo)
sd(nrmse_rare_nophylo)

# RMSE
rmse_rare_nophylo <- apply(pp_rare_nophylo, 1, function(x) rmse(pred=x,obs=vet_rare_nophylo$data$rare))
mean(rmse_rare_nophylo)
sd(rmse_rare_nophylo)

```

## Full rarity model: only brownian family effects

```{r frac_rare_phylo, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_phylo_10k.rds")) {

  vet_rare_phylo <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal+ (1|family), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_phylo, "./vet_rare_phylo_10k.rds")

} else { vet_rare_phylo <- readRDS("./vet_rare_phylo_10k.rds")}

outcome <- summary(vet_rare_phylo$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects")

vet_rare_phylo_plot <- stanplot(vet_rare_phylo, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_phylo_plot

# pdf("./plots_tables/vet_rare_phylo_plot.pdf", width=5, height=4)
# vet_rare_phylo_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/vet_rare_phylo.tex")


##Posterior predictive checks
pp_rare_phylo <- brms::posterior_predict(vet_rare_phylo)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_phylo$data$rare, pp_rare_phylo[1:50, ]) + scale_x_continuous(trans="log1p")


# NRMSE
nrmse_rare_phylo <- apply(pp_rare_phylo, 1, function(x) nrmse(pred=x,obs=vet_rare_phylo$data$rare, type="iq"))
mean(nrmse_rare_phylo)
sd(nrmse_rare_phylo)

# RMSE
rmse_rare_phylo <- apply(pp_rare_phylo, 1, function(x) rmse(pred=x,obs=vet_rare_phylo$data$rare))
mean(rmse_rare_phylo)
sd(rmse_rare_phylo)

```

## Full rarity model (total species richness - not vetted by IUCN)

```{r frac_rnonare_vetted, echo=TRUE, eval=TRUE}

if (!file.exists("./nonvet_rare_10k.rds")) {

  nonvet_rare <- brm(rare | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(nonvet_rare, "./nonvet_rare_10k.rds")

} else { nonvet_rare <- readRDS("./nonvet_rare_10k.rds")}

outcome <- summary(nonvet_rare$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

nonvet_rare_plot <- stanplot(nonvet_rare, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")
nonvet_rare_plot

# pdf("./plots_tables/nonvet_rare_plot.pdf", width=5, height=4)
# nonvet_rare_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/nonvet_rare.tex")

##Posterior predictive checks
pp_rare <- brms::posterior_predict(nonvet_rare)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=nonvet_rare$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_nonvet <- apply(pp_rare, 1, function(x) nrmse(pred=x,obs=nonvet_rare$data$rare, type="iq"))
mean(nrmse_nonvet)
sd(nrmse_nonvet)

# RMSE
rmse_nonvet <- apply(pp_rare, 1, function(x) rmse(pred=x,obs=nonvet_rare$data$rare))
mean(rmse_nonvet)
sd(rmse_nonvet)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(nonvet_rare, hyp, class = NULL))

```

## Invasive model

```{r frac_inv, echo=TRUE, eval=TRUE}

if (!file.exists("./fit_inv_10k.rds")) {

  fit_inv <- brm(Invasive | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=11))

  saveRDS(fit_inv, "./fit_inv_10k.rds")

} else { fit_inv <- readRDS("./fit_inv_10k.rds")}

outcome <- summary(fit_inv$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

fit_inv_plot <- stanplot(fit_inv, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))+ ggtitle("Proportion of invasive species")

fit_inv_plot

# pdf("./plots_tables/fit_inv_plot.pdf", width=5, height=4)
# fit_inv_plot + ggtitle("")
# dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)
to_print <- to_print[,c("mean","sd","2.5%","50%","97.5%","n_eff","Rhat")]
print(xtable(to_print, type = "latex"), file = "./plots_tables/invasive.tex")

##Posterior predictive checks
pp_inv <- brms::posterior_predict(fit_inv)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_inv$data$Invasive, pp_inv[1:50, ]) + scale_x_continuous(trans="log1p")

# NRMSE
nrmse_inv <- apply(pp_inv, 1, function(x) nrmse(pred=x,obs=fit_inv$data$Invasive, type="iq"))
mean(nrmse_inv)
sd(nrmse_inv)

# RMSE
rmse_inv <- apply(pp_inv, 1, function(x) rmse(pred=x,obs=fit_inv$data$Invasive))
mean(rmse_inv)
sd(rmse_inv)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(fit_inv, hyp, class = NULL))

```