---
title: "Invasiveness and Rarity across Angiosperm Families"
author: "Maxwell J. Farrell"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  html_document:
    highlight: default
    toc: yes
    toc_depth: 2
    toc_float: true
    theme: yeti
urlcolor: blue
---

<!-- knit with Rscript -e "rmarkdown::render('angiosperm_invasion.Rmd')" -->

## Questions

1. Are plant families with more rare species more uniform in functional traits?
2. Are plant families with more invasive species more heterogeneous in functional traits?
3. Are rarity and invasiveness correlated across families?

Outcomes to show:

- Sampling effect of clade size
- Differences from predicted values
- Family effects


## Introduction Outline

- Traits underlying rarity and invasiveness have been studied before and are important for XXX
- These patterns have (rarely, or never?) been analyzed at the global scale 
- The potential for rarity and invasiveness may increase with number of species in a clade (pure sampling effect), leading to the prediction that both rarea and invasive species will be found in larger families (rarity and invasiveness are positively correlated). 
- However, different functional traits are likely to be underlying rarity and invasiveness (examples)
- Here we present a family level comparative analyses of rarity and invasiveness for all plants, and identify XX and YYY 


- Family effects



## To Do

- Try models without family age (is this redundant with a phylogenetic covariance matrix?)

- Try without family effect (to see if this causes the directionaliry shift from JPs models)

- Try without Orchids (sensitivity analysis)

- Potential other predictors: number of known hybrids in a family

- Posterior predictions - which families have more invasive, or less rare species than predicted from the model? FOR DISCUSSION

- correlation (regression) of rarity versus invasive (with size as only other predictor)


##Packages
```{r loading packages, echo=T, message=F, warning=F}
require(tidyr)
require(dplyr)
require(magrittr)
require(ggplot2)
require(bayesplot)
require(ape)
require(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
require(brms)
require(ggmcmc)
require(knitr)
```

##Loading data

```{r loading data, echo=T, message=F, warning=F, results='hide'}

data <- read.csv("./sp.rare.inv.csv", as.is=F)
# data %>% purrr::keep(is.numeric) %>% cor(., use="complete.obs") %>% View()

# one family has more rare species than species
data[data$rare>data$species,]

# increasing species by 1 to match
data$species[data$family=="Metteniusaceae"] <- 8

### Zanne tree & generating tree representing families
tree <- read.tree("./Vascular_Plants_rooted.dated.tre")
spec_fam <- read.csv("./spec.fam.csv", as.is=T)
tree <- drop.tip(tree, setdiff(tree$tip.label,as.character(spec_fam$sp)))
lookup <- setNames(spec_fam$family, spec_fam$sp)
tree$tip.label <- as.character(lookup[tree$tip.label])

# These families we have data for, but are not in tree
setdiff(data$family, tree$tip.label)

# remove missing families in data
data <- data[data$family%in%tree$tip.label,]


### Davies tree
# tree <- read.tree("./ultrametric.phy")

# # some families missing...
# length(intersect(data$family, tree$tip.label))
# setdiff(data$family, tree$tip.label)
# setdiff(tree$tip.label, data$family)

# # drop these from the tree
# tree <- drop.tip(tree, setdiff(tree$tip.label,as.character(data$family)))

# # remove missing families in data
# data <- data[data$family%in%tree$tip.label,]

# phylogenetic correlation structure
phy_cov <- vcv(tree, corr=TRUE)

# Getting new family age
min_above_zero <- function(x){

  if (length(x)>1) {
    min(x[x>0])
  } else {0}

}

# Calculate family age (may be influenced by families missing from the tree)
coph <- cophenetic(tree)

fam_age <- sapply(rownames(coph), function(fam) 
          min_above_zero(coph[rownames(coph)%in%fam,])
          ) 
old_ages <- data %>% select(family, age)
new_ages <- data.frame(family=names(fam_age), new_age=as.numeric(fam_age)/2)
new_ages %<>% arrange(family)
data <- left_join(data,new_ages)

with(data, plot(age ~ new_age, pch=20))
with(data, cor(age,new_age))


```
&nbsp;
&nbsp;

<!-- ##Histograms of numeric predictors -->

```{r histograms, echo=F, eval=F}
ggplot(gather(data[,2:21]%>% purrr::keep(is.numeric)), aes(value)) + 
    geom_histogram(bins = 10) + 
    facet_wrap(~key, scales = 'free')

ggplot(gather(data[,22:41]%>% purrr::keep(is.numeric)), aes(value)) + 
    geom_histogram(bins = 10) + 
    facet_wrap(~key, scales = 'free')

ggplot(gather(data[,42:65]%>% purrr::keep(is.numeric)), aes(value)) + 
    geom_histogram(bins = 10) + 
    facet_wrap(~key, scales = 'free')


```

<!-- ## Pairs of predictors-->

```{r pred_pairs, echo=F, eval=F}

dat2 <- data[,c("forms2","sum.photo","breeding.sum","climate.sum","age","species")]
dat2$age <- log10(dat2$age)
dat2$species <- log10(dat2$species)

pairs(dat2)

with(data, plot(breeding.sum, breeding.sum2))
with(data, cor(breeding.sum, breeding.sum2))

with(data, plot(forms, forms2))
with(data, cor(forms, forms2))

with(data, plot(sum.photo, sum.photo2))
with(data, cor(sum.photo, sum.photo2))

```

## Relationship between rarity and invasiveness categories
```{r rare_invasive, echo=TRUE, eval=TRUE}

if (!file.exists("./rare_invasive_2k.rds")) {

  rare_inv <- brm(rare | trials(species) ~ log10(Invasive+1) + log10(new_age) +log10(species) +  (1|family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=2)

  saveRDS(rare_inv, "./rare_invasive_2k.rds")

} else { rare_inv <- readRDS("./rare_invasive_2k.rds")}

rare_inv

outcome <- summary(rare_inv$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(rare_inv, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(rare_inv)

##Posterior predictive checks
# first make posterior predictions
pp_rare_inv <- brms::posterior_predict(rare_inv)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=rare_inv$data$rare, pp_rare_inv[1:50, ]) + scale_x_continuous(trans="log1p")


if (!file.exists("./rare_naturalized_2k.rds")) {

  rare_nat <- brm(rare | trials(species) ~ log10(Naturalised+1) + log10(new_age) +log10(species) +  (1|family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=2)

  saveRDS(rare_nat, "./rare_naturalized_2k.rds")

} else { rare_nat <- readRDS("./rare_naturalized_2k.rds")}

rare_nat

outcome <- summary(rare_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(rare_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(rare_nat)

##Posterior predictive checks
# first make posterior predictions
pp_rare_nat <- brms::posterior_predict(rare_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=rare_nat$data$rare, pp_rare_nat[1:50, ]) + scale_x_continuous(trans="log1p")



if (!file.exists("./rare_environmental_2k.rds")) {

  rare_env <- brm(rare | trials(species) ~ log10(Environ+1) + log10(new_age) +log10(species) +  (1|family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=2)

  saveRDS(rare_env, "./rare_environmental_2k.rds")

} else { rare_env <- readRDS("./rare_environmental_2k.rds")}

rare_env

outcome <- summary(rare_env$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(rare_env, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(rare_env)

##Posterior predictive checks
# first make posterior predictions
pp_rare_env <- brms::posterior_predict(rare_env)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=rare_env$data$rare, pp_rare_env[1:50, ]) + scale_x_continuous(trans="log1p")



```



## Proportion rare species
```{r frac_rare, echo=TRUE, eval=TRUE}

if (!file.exists("./fit_rare_2k.rds")) {

  fit_rare <- brm(rare | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(fit_rare, "./fit_rare_2k.rds")

} else { fit_rare <- readRDS("./fit_rare_2k.rds")}

fit_rare

outcome <- summary(fit_rare$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_rare, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_rare)

##Posterior predictive checks
# first make posterior predictions
pp_rare <- brms::posterior_predict(fit_rare)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_rare$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")


```


## Proportion naturalized species
```{r frac_nat, echo=TRUE, eval=TRUE}


if (!file.exists("./fit_nat_2k.rds")) {

  fit_nat <- brm(Naturalised | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=11))

  saveRDS(fit_nat, "./fit_nat_2k.rds")

} else { fit_nat <- readRDS("./fit_nat_2k.rds")}

fit_nat

# pairs(fit_nat)

outcome <- summary(fit_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_nat)

##Posterior predictive checks
# first make posterior predictions
pp_nat <- brms::posterior_predict(fit_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_nat$data$Naturalised, pp_nat[1:50, ]) + scale_x_continuous(trans="log1p")


```


## Proportion invasive species
```{r frac_inv, echo=TRUE, eval=TRUE}

# Invasive

if (!file.exists("./fit_inv_2k.rds")) {

  fit_inv <- brm(Invasive | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8,max_treedepth=12))

  saveRDS(fit_inv, "./fit_inv_2k.rds")

} else { fit_inv <- readRDS("./fit_inv_2k.rds")}

fit_inv

# pairs(fit_inv)

outcome <- summary(fit_inv$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_inv, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_inv)

##Posterior predictive checks
# first make posterior predictions
pp_inv <- brms::posterior_predict(fit_inv)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_inv$data$Invasive, pp_inv[1:50, ]) + scale_x_continuous(trans="log1p")


```


## Proportion weed species
```{r frac_weed, echo=TRUE, eval=T}

if (!file.exists("./fit_weed_2k.rds")) {

  fit_weed <- brm(Weed | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=12), cores=2)

  saveRDS(fit_weed, "./fit_weed_2k.rds")

} else { fit_weed <- readRDS("./fit_weed_2k.rds")}

fit_weed

# pairs(fit_weed)

outcome <- summary(fit_weed$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_weed, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_weed)

##Posterior predictive checks
# first make posterior predictions
pp_weed <- brms::posterior_predict(fit_weed)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_weed$data$Weed, pp_weed[1:50, ]) + scale_x_continuous(trans="log1p")


```


## Proportion agricultural weed species
```{r frac_ag, echo=TRUE, eval=T}

# Agricultural.Weed

if (!file.exists("./fit_ag_2k.rds")) {

  fit_ag <- brm(Agricultural.Weed | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=12), cores=2)

  saveRDS(fit_ag, "./fit_ag_2k.rds")

} else { fit_ag <- readRDS("./fit_ag_2k.rds")}

fit_ag

# pairs(fit_ag)

outcome <- summary(fit_ag$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_ag, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_ag)

##Posterior predictive checks
# first make posterior predictions
pp_ag <- brms::posterior_predict(fit_ag)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_ag$data$Agricultural.Weed, pp_ag[1:50, ]) + scale_x_continuous(trans="log1p")

```


## Proportion Environ
```{r frac_env, echo=TRUE, eval=T}

# Environ

if (!file.exists("./fit_env_2k.rds")) {

  fit_env <- brm(Environ | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=12))

  saveRDS(fit_env, "./fit_env_2k.rds")

} else { fit_env <- readRDS("./fit_env_2k.rds")}

fit_env

# pairs(fit_env)

outcome <- summary(fit_env$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_env, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_env)

##Posterior predictive checks
# first make posterior predictions
pp_env <- brms::posterior_predict(fit_env)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_env$data$Environ, pp_env[1:50, ]) + scale_x_continuous(trans="log1p")

```


## Proportion noxious
```{r frac_nox, echo=TRUE, eval=T}

# Noxious

if (!file.exists("./fit_nox_2k.rds")) {

  fit_nox <- brm(Noxious | trials(species) ~ forms2 + annual + woody + succulent + climate.sum + wind + herbaceous + shybrids + log10(new_age) + log10(species) + hermaphroditic + dioec2 + monoec2 + asexual + animal + (1 | family), 
    dat=data, family=binomial(), 
    iter=2000, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=12))

  saveRDS(fit_nox, "./fit_nox_2k.rds")

} else { fit_nox <- readRDS("./fit_nox_2k.rds")}

fit_nox

# pairs(fit_nox)

outcome <- summary(fit_nox$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
kable(to_print, digits=2)

stanplot(fit_nox, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean")

bayes_R2(fit_nox)

##Posterior predictive checks
# first make posterior predictions
pp_nox <- brms::posterior_predict(fit_nox)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_nox$data$Noxious, pp_nox[1:50, ]) + scale_x_continuous(trans="log1p")

```

