---
title: "Threatened and Naturalized plants across Angiosperm Families"
author: "Maxwell J. Farrell"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  html_document:
    highlight: default
    toc: yes
    toc_depth: 3
    toc_float: true
    theme: yeti
urlcolor: blue
---

<!-- knit with 
Rscript -e "rmarkdown::render('threat_naturalized_plant_families.Rmd')"
 -->

# Set up

## Packages 

```{r loading packages, echo=T, message=F, warning=F}
require(tidyr)
require(dplyr)
require(magrittr)
require(ggplot2)
require(bayesplot)
require(ape)
require(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
require(brms)
require(ggmcmc)
require(knitr)
require(phytools)
require(cowplot)
require(RColorBrewer)
require(ggtree)
require(car)

# RMSE function
RMSE = function(m, o){
  sqrt(mean((m - o)^2))
}

# NRMSE function
nrmse <-  function(obs, pred, type = "sd") {
  
    squared_sums <- sum((obs - pred)^2)
    mse <- squared_sums/length(obs)
    rmse <- sqrt(mse)
    if (type == "sd") nrmse <- rmse/sd(obs)
    if (type == "mean") nrmse <- rmse/mean(obs)
    if (type == "maxmin") nrmse <- rmse/ (max(obs) - min(obs))
    if (type == "iq") nrmse <- rmse/ (quantile(obs, 0.75) - quantile(obs, 0.25))
    if (!type %in% c("mean", "sd", "maxmin", "iq")) message("Wrong type!")
    nrmse <- round(nrmse, 3)
 return(nrmse)
    
}

```

## Loading data

```{r loading data, echo=T, message=F, warning=F, results='hide'}

data <- read.csv("./sp.rare.inv.csv", as.is=F)

# one family has more rare species than species
data[data$rare>data$species,]

# increasing species by 1 to match
data$species[data$family=="Metteniusaceae"] <- 8

nrow(data)# 407
range(data$vetted)
nrow(data[data$vetted>0,])# 260

# creating column for woodiness
data$woodiness <- data$herbaceous + data$woody + data$variable

# fixing typo in names 
names(data)[names(data)%in%"dmonoecious"] <- "monoecious"

### Zanne tree & generating tree representing families
tree <- read.tree("./Vascular_Plants_rooted.dated.tre")
spec_fam <- read.csv("./spec.fam.csv", as.is=T)
tree <- drop.tip(tree, setdiff(tree$tip.label,as.character(spec_fam$sp)))
lookup <- setNames(spec_fam$family, spec_fam$sp)
tree$tip.label <- as.character(lookup[tree$tip.label])

# Getting new family age
min_above_zero <- function(x){

  if (length(x)>1) {
    min(x[x>0])
  } else {0}

}

# Calculate family age (may be influenced by families missing from the tree)
coph <- cophenetic(tree)

fam_age <- sapply(rownames(coph), function(fam) 
          min_above_zero(coph[rownames(coph)%in%fam,])
          ) 

new_ages <- data.frame(family=names(fam_age), new_age=as.numeric(fam_age)/2)
new_ages %<>% arrange(family)
data <- left_join(data,new_ages)

# There are some ages of NA (not in tree?)
# Remove these
data <- data[!is.na(data$new_age),]

# Calculating simple diversification metric - log(N+1)/age
data$diversification <- with(data, log(species)/new_age)

# creating another family level variable (for non-phylogenetic family level effects)
data$family_name <- data$family

# These families we have data for, but are not in tree
setdiff(data$family, tree$tip.label) 
# none

# Identify families in tree with no data
setdiff(tree$tip.label, data$family)
# Centrolepidaceae

# remove missing families in data
data <- data[data$family%in%tree$tip.label,]

# remove families in tree with no data 
tree <- drop.tip(tree, setdiff(tree$tip.label, as.character(data$family)))

# phylogenetic correlation structure
phy_cov <- vcv(tree, corr=TRUE)

```

```{r raw_data_plot, echo=F, eval=F}

# Order dat to match tree tip labels
dat <- data[match(tree$tip.label,data$family),]

# threat
threat <- dat$rare/dat$vetted
names(threat) <- tree$tip.label
# remove NaN families
threat <- threat[!is.nan(threat)]
# remove these from dat
dat <- dat[dat$family %in% names(threat),]

# prune tree
p_tree <- drop.tip(tree, setdiff(tree$tip.label, as.character(dat$family)))
dat <- dat[match(p_tree$tip.label,dat$family),]

# naturalization
nat <- dat$Naturalised/dat$species
names(nat) <- p_tree$tip.label

# adding contmap of diversification
div <- dat$diversification
names(div) <- p_tree$tip.label

# Creating diversity mapping
obj<-contMap(p_tree,div,plot=FALSE)

##############
# https://guangchuangyu.github.io/2016/10/facet_plot-a-general-solution-to-associate-data-with-phylogenetic-tree/

cols<-c("#88b7c5","#606890","#18477c","#a36666","#dfc453")

fit <- phytools::fastAnc(p_tree,div,vars=TRUE,CI=TRUE)
td <- data.frame(node = nodeid(p_tree, names(div)),
               trait = div)
nd <- data.frame(node = names(fit$ace), trait = fit$ace)
d <- rbind(td, nd)
d$node <- as.numeric(d$node)

p <- ggtree(p_tree, aes(color=d$trait), layout = 'rectangular', 
        ladderize = FALSE, size=0.4) + theme_tree2(legend.position = c(.08, .85),legend.title=element_text(size=8),strip.background =element_rect(fill="white"),panel.border = element_rect(colour = "white")) +
      scale_colour_viridis_c(direction=-1, name="Diversification rate")
# p

d2 <- data.frame(id=p_tree$tip.label,threat,nat)

p <- p %<+% d2

p2 <- facet_plot(p, panel = 'Proportion threatened', data = d2, 
                geom = ggstance::geom_barh, 
                aes(x = -threat), 
                stat='identity',
                color=cols[4], fill=cols[4], width=0.03)
# p2 # Don't know how to flip axis only on the second plot... will remove negative signs in Inkscape

p3 <- facet_plot(p2, panel = 'Proportion naturalised', data = d2, 
                geom = ggstance::geom_barh, 
                aes(x = nat), 
                stat='identity',
                color=cols[1],fill=cols[1], width=0.03) #+ scale_x_reverse()

p3 <- p3 + facet_grid(.~panel, scale="free_x") + scale_y_continuous(expand = c(0,3)) + scale_x_continuous(expand = c(0,0.04))

p3

ggsave("./plots_tables/div_threatVetted_nat_plot_2.pdf",p3, height=6,width=8)

```

## Transforming predictors

```{r transforming predictors}

# Code for scale and unscale with mean=0 sd=0.5 (following Gelman 2008)
scale_half <- function(x){
  return( (x-mean(x)) * 0.5/sd(x))
}

unscale_half <- function(x,original){
    x*sd(original)*2 + mean(original)  
}

# Converting species.hybrids to proportion
data$species.hybrids <- data$species.hybrids/data$species

# Scaling continuous predictors
data$new_age_scaled <- scale_half(log(data$new_age))
data$species_scaled <- scale_half(log(data$species))
data$diversification_scaled <- scale_half(log(data$diversification+1))
data$Naturalised_scaled <- scale_half(log(data$Naturalised+1))
data$species.hybrids <- scale_half(data$species.hybrids)

# Subsetting to IUCN vetted species (for rarity models)
data_vetted <- data[data$vetted>0,]
tree_vetted <- drop.tip(tree, setdiff(tree$tip.label, as.character(data_vetted$family)))
phy_cov_vetted <- vcv(tree_vetted, corr=TRUE)

```

## Assessing multicollinearity

```{r vifs}

vif(lm(rare ~ Naturalised_scaled + diversification_scaled + new_age_scaled, data=data_vetted))

vif(lm(rare ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, data=data_vetted))

vif(lm(rare ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, data=data))

```
&nbsp;
&nbsp;


# Rarity models  (with IUCN evaluated species)

## Simple rarity model

```{r rare_nat_vetted, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_naturalized_10k.rds")) {

  vet_rare_nat <- brm(rare | trials(vetted) ~ Naturalised_scaled + diversification_scaled + new_age_scaled +  (1|family) + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.95,max_treedepth=12), cores=4)

  saveRDS(vet_rare_nat, "./vet_rare_naturalized_10k.rds")

} else { vet_rare_nat <- readRDS("./vet_rare_naturalized_10k.rds")}

outcome <- summary(vet_rare_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Number of naturalized species","Diversification rate","Family age","SD brownian effects","SD family specific effects")

vet_rare_nat_plot <- stanplot(vet_rare_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))

vet_rare_nat_plot

pdf("./plots_tables/vet_rare_nat_plot.pdf", width=4, height=3)
vet_rare_nat_plot
dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)

##Posterior predictive checks
pp_vet_rare_nat <- brms::posterior_predict(vet_rare_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nat$data$rare, pp_vet_rare_nat[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_vet_rare_nat <- apply(pp_vet_rare_nat, 1, function(x) RMSE(x,vet_rare_nat$data$rare))
# plot(density(rmse_vet_rare_nat), main="RMSE across posterior predictions")
mean(rmse_vet_rare_nat)
sd(rmse_vet_rare_nat)

# NRMSE
nrmse_vet_rare_nat <- apply(pp_vet_rare_nat, 1, function(x) nrmse(pred=x,obs=vet_rare_nat$data$rare, type="iq"))
mean(nrmse_vet_rare_nat)
sd(nrmse_vet_rare_nat)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare_nat, hyp, class = NULL))

```

## Full rarity model (IUCN vetted species)

```{r frac_rare_vetted, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_10k.rds")) {

  vet_rare <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov_vetted),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare, "./vet_rare_10k.rds")

} else { vet_rare <- readRDS("./vet_rare_10k.rds")}

outcome <- summary(vet_rare$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age","Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

vet_rare_plot <- stanplot(vet_rare, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

vet_rare_plot

pdf("./plots_tables/vet_rare_plot.pdf", width=4, height=7)
vet_rare_plot
dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)

##Posterior predictive checks
# first make posterior predictions
pp_rare <- brms::posterior_predict(vet_rare)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_vet <- apply(pp_rare, 1, function(x) RMSE(x,vet_rare$data$rare))
mean(rmse_vet)
sd(rmse_vet)

# NRMSE
nrmse_vet <- apply(pp_rare, 1, function(x) nrmse(pred=x,obs=vet_rare$data$rare, type="iq"))
mean(nrmse_vet)
sd(nrmse_vet)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(vet_rare, hyp, class = NULL))
# plot(hyp)


```

# Naturalized model

## Proportion naturalized species

```{r frac_nat, echo=TRUE, eval=TRUE}

if (!file.exists("./fit_nat_10k.rds")) {

  fit_nat <- brm(Naturalised | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=11))

  saveRDS(fit_nat, "./fit_nat_10k.rds")

} else { fit_nat <- readRDS("./fit_nat_10k.rds")}

outcome <- summary(fit_nat$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

fit_nat_plot <- stanplot(fit_nat, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))+ ggtitle("Proportion of naturalized species")

fit_nat_plot

pdf("./plots_tables/fit_nat_plot.pdf", width=4, height=7)
fit_nat_plot
dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)

##Posterior predictive checks
pp_nat <- brms::posterior_predict(fit_nat)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_nat$data$Naturalised, pp_nat[1:50, ]) + scale_x_continuous(trans="log1p")

rmse_nat <- apply(pp_nat, 1, function(x) RMSE(x,fit_nat$data$Naturalised))
plot(density(rmse_nat), main="RMSE across posterior predictions")
mean(rmse_nat)
sd(rmse_nat)

# NRMSE
nrmse_nat <- apply(pp_nat, 1, function(x) nrmse(pred=x,obs=fit_nat$data$Naturalised, type="iq"))
mean(nrmse_nat)
sd(nrmse_nat)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(fit_nat, hyp, class = NULL))


```

# Combined Forest Plot
```{r, echo=T, eval=T}

a <- vet_rare_plot + xlim(-4.5, 5)
b <- fit_nat_plot + xlim(-4.5, 5) + theme(axis.text.y=element_blank())

theme_set(theme_cowplot(font_size=12)) # reduce default font size
plot_grid(a, b, labels = c(' ', ' '), align='h', label_x=0.93, rel_widths=c(1,0.66))

# ggsave("plots_tables/combined_forest_plot.png", width=8, height=5, units="in")
# ggsave("plots_tables/combined_forest_plot.pdf", width=8, height=5, units="in")

```



```{r, fig.width=8, fig.height=8, eval=T, echo=F}
# Phylogenetic effects plots (IUCN vetted full rarity model)

# Combined plot - rarity

# Extract species level effects
ranef_phy <- ranef(vet_rare)$family
ranef_binom <- ranef(vet_rare)$family_name
ranef_spec <- ranef_phy + ranef_binom

ranef_phy <- as.data.frame(unlist(ranef_phy))
ranef_binom <- as.data.frame(unlist(ranef_binom))
ranef_spec <- as.data.frame(unlist(ranef_spec))

# re-order efects to match tree
tree_small <- drop.tip(tree, setdiff(tree$tip.label, rownames(ranef_spec)))
ranef_phy <- ranef_phy[tree_small$tip.label,]
ranef_binom <- ranef_binom[tree_small$tip.label,]
ranef_spec <- ranef_spec[tree_small$tip.label,]

# Plot the beside the phylogeny
cols <- c("#7570b3","#d95f02")

pdf("./plots_tables/phylo_rarity_barplot_combined.pdf", width=30, height=10)
par(mfrow=c(1,3))

# Brownian phylogenetic effects

phy_effects <- abs(ranef_phy$Estimate.Intercept)
names(phy_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=phy_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

legend(-320,320,legend=c("Positive","Negative"),
       col=cols,lty=1, lwd=6, cex=1.3, box.lwd=0, box.col="white")


# Family specific effects (non-brownian)

binom_effects <- abs(ranef_binom$Estimate.Intercept)
names(binom_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=binom_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

# Family total Brownian + Family Specific

fam_effects <- abs(ranef_spec$Estimate.Intercept)
names(fam_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=fam_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

dev.off()



# Combined plot - naturalization

# Extract species level effects
ranef_phy <- ranef(fit_nat)$family
ranef_binom <- ranef(fit_nat)$family_name
ranef_spec <- ranef_phy + ranef_binom

ranef_phy <- as.data.frame(unlist(ranef_phy))
ranef_binom <- as.data.frame(unlist(ranef_binom))
ranef_spec <- as.data.frame(unlist(ranef_spec))

# re-order efects to match tree
tree_small <- drop.tip(tree, setdiff(tree$tip.label, rownames(ranef_spec)))
ranef_phy <- ranef_phy[tree_small$tip.label,]
ranef_binom <- ranef_binom[tree_small$tip.label,]
ranef_spec <- ranef_spec[tree_small$tip.label,]

# Plot the beside the phylogeny
cols <- c("#7570b3","#d95f02")

pdf("./plots_tables/phylo_naturalization_barplot_combined.pdf", width=30, height=10)
par(mfrow=c(1,3))

# Brownian phylogenetic effects

phy_effects <- abs(ranef_phy$Estimate.Intercept)
names(phy_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=phy_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

legend(-320,320,legend=c("Positive","Negative"),
       col=cols,lty=1, lwd=6, cex=1.3, box.lwd=0, box.col="white")


# Family specific effects (non-brownian)

binom_effects <- abs(ranef_binom$Estimate.Intercept)
names(binom_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=binom_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

fam_effects <- abs(ranef_spec$Estimate.Intercept)
names(fam_effects) <- tree_small$tip.label

plotTree.wBars(tree_small,x=fam_effects,scale=20, type="fan", width=3.75, col=cols[ifelse(ranef_spec$Estimate.Intercept>0,1,2)], border=0)

dev.off()


```

# Sensitivity analyses

## Full rarity model: no family level effects

```{r frac_rare_nofam, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_nofam_10k.rds")) {

  vet_rare_nofam <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal, 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4,
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_nofam, "./vet_rare_nofam_10k.rds")

} else { vet_rare_nofam <- readRDS("./vet_rare_nofam_10k.rds")}

outcome <- summary(vet_rare_nofam$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated")

vet_rare_nofam_plot <- stanplot(vet_rare_nofam, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

rownames(to_print) <- names1
kable(to_print, digits=2)

vet_rare_nofam_plot

pdf("./plots_tables/vet_rare_nofam_plot.pdf", width=4, height=7)
vet_rare_nofam_plot
dev.off()

##Posterior predictive checks
# first make posterior predictions
pp_rare_nofam <- brms::posterior_predict(vet_rare_nofam)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nofam$data$rare, pp_rare_nofam[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_rare_nofam <- apply(pp_rare_nofam, 1, function(x) RMSE(x,vet_rare_nofam$data$rare))
mean(rmse_rare_nofam)
sd(rmse_rare_nofam)

# NRMSE
nrmse_rare_nofam <- apply(pp_rare_nofam, 1, function(x) nrmse(pred=x,obs=vet_rare_nofam$data$rare, type="iq"))
mean(nrmse_rare_nofam)
sd(nrmse_rare_nofam)

```

## Full rarity model: only non-brownian family effects

```{r frac_rare_nophylo, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_nophylo_10k.rds")) {

  vet_rare_nophylo <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family_name), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4,
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_nophylo, "./vet_rare_nophylo_10k.rds")

} else { vet_rare_nophylo <- readRDS("./vet_rare_nophylo_10k.rds")}

outcome <- summary(vet_rare_nophylo$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD family specific effects")

vet_rare_nophylo_plot <- stanplot(vet_rare_nophylo, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

rownames(to_print) <- names1
kable(to_print, digits=2)

vet_rare_nophylo_plot

pdf("./plots_tables/vet_rare_nophylo_plot.pdf", width=4, height=7)
vet_rare_nophylo_plot
dev.off()

##Posterior predictive checks
pp_rare_nophylo <- brms::posterior_predict(vet_rare_nophylo)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_nophylo$data$rare, pp_rare_nophylo[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_rare_nophylo <- apply(pp_rare_nophylo, 1, function(x) RMSE(x,vet_rare_nophylo$data$rare))
mean(rmse_rare_nophylo)
sd(rmse_rare_nophylo)

# NRMSE
nrmse_rare_nophylo <- apply(pp_rare_nophylo, 1, function(x) nrmse(pred=x,obs=vet_rare_nophylo$data$rare, type="iq"))
mean(nrmse_rare_nophylo)
sd(nrmse_rare_nophylo)

```

## Full rarity model: only brownian family effects

```{r frac_rare_phylo, echo=TRUE, eval=TRUE}

if (!file.exists("./vet_rare_phylo_10k.rds")) {

  vet_rare_phylo <- brm(rare | trials(vetted) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal+ (1|family), 
    dat=data_vetted, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(vet_rare_phylo, "./vet_rare_phylo_10k.rds")

} else { vet_rare_phylo <- readRDS("./vet_rare_phylo_10k.rds")}

outcome <- summary(vet_rare_phylo$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects")

vet_rare_phylo_plot <- stanplot(vet_rare_phylo, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

rownames(to_print) <- names1
kable(to_print, digits=2)

vet_rare_phylo_plot

pdf("./plots_tables/vet_rare_phylo_plot.pdf", width=4, height=7)
vet_rare_phylo_plot
dev.off()

##Posterior predictive checks
pp_rare_phylo <- brms::posterior_predict(vet_rare_phylo)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=vet_rare_phylo$data$rare, pp_rare_phylo[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_rare_phylo <- apply(pp_rare_phylo, 1, function(x) RMSE(x,vet_rare_phylo$data$rare))
mean(rmse_rare_phylo)
sd(rmse_rare_phylo)

# NRMSE
nrmse_rare_phylo <- apply(pp_rare_phylo, 1, function(x) nrmse(pred=x,obs=vet_rare_phylo$data$rare, type="iq"))
mean(nrmse_rare_phylo)
sd(nrmse_rare_phylo)

```

## Full rarity model (total species richness - not vetted by IUCN)

```{r frac_rnonare_vetted, echo=TRUE, eval=TRUE}

if (!file.exists("./nonvet_rare_10k.rds")) {

  nonvet_rare <- brm(rare | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.95,max_treedepth=13))

  saveRDS(nonvet_rare, "./nonvet_rare_10k.rds")

} else { nonvet_rare <- readRDS("./nonvet_rare_10k.rds")}

outcome <- summary(nonvet_rare$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

nonvet_rare_plot <- stanplot(nonvet_rare, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print))) + ggtitle("Proportion rare species")

nonvet_rare_plot

pdf("./plots_tables/nonvet_rare_plot.pdf", width=4, height=7)
nonvet_rare_plot
dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)

##Posterior predictive checks
pp_rare <- brms::posterior_predict(nonvet_rare)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=nonvet_rare$data$rare, pp_rare[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_nonvet <- apply(pp_rare, 1, function(x) RMSE(x,nonvet_rare$data$rare))
mean(rmse_nonvet)
sd(rmse_nonvet)

# NRMSE
nrmse_nonvet <- apply(pp_rare, 1, function(x) nrmse(pred=x,obs=nonvet_rare$data$rare, type="iq"))
mean(nrmse_nonvet)
sd(nrmse_nonvet)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(nonvet_rare, hyp, class = NULL))

```

## Invasive model

```{r frac_inv, echo=TRUE, eval=TRUE}

if (!file.exists("./fit_inv_10k.rds")) {

  fit_inv <- brm(Invasive | trials(species) ~ diversification_scaled + new_age_scaled + woodiness + herbaceous + climate.sum + species.hybrids + hermaphroditic + dioecious + monoecious + asexual + fleshy.fruit + animal + (1|family) + (1|family_name), 
    dat=data, family=binomial(), 
    iter=10000, thin=4, cov_ranef = list(family = phy_cov),
    control=list(adapt_delta=0.8, max_treedepth=11))

  saveRDS(fit_inv, "./fit_inv_10k.rds")

} else { fit_inv <- readRDS("./fit_inv_10k.rds")}

outcome <- summary(fit_inv$fit)
to_print <- outcome$summary[grep("^[sd,b]_*",rownames(outcome$summary)),]
to_print <- to_print[-1,]

names1 <- c("Diversification rate","Famly age", "Woodiness","Herbaceous","Climate sum","Number of species hybrids","Hermaphroditic","Dioecious","Monoecious","Asexual","Fleshy fruit","Animal pollinated","SD brownian effects","SD family specific effects")

fit_inv_plot <- stanplot(fit_inv, pars=rownames(to_print), type="intervals", 
                    prob=0.8, prob_outer=0.95, point_est="mean") + scale_y_discrete(labels=rev(names1), limits=rev(rownames(to_print)))+ ggtitle("Proportion of invasive species")

fit_inv_plot

pdf("./plots_tables/fit_inv_plot.pdf", width=4, height=7)
fit_inv_plot
dev.off()

rownames(to_print) <- names1
kable(to_print, digits=2)

##Posterior predictive checks
pp_inv <- brms::posterior_predict(fit_inv)

log1 <- scale_x_continuous(trans="log1p")

ppc_dens_overlay(y=fit_inv$data$Invasive, pp_inv[1:50, ]) + scale_x_continuous(trans="log1p")

# RMSE
rmse_inv <- apply(pp_inv, 1, function(x) RMSE(x,fit_inv$data$Invasive))
mean(rmse_inv)
sd(rmse_inv)

# NRMSE
nrmse_inv <- apply(pp_inv, 1, function(x) nrmse(pred=x,obs=fit_inv$data$Invasive, type="iq"))
mean(nrmse_inv)
sd(nrmse_inv)

# family-level variance due to brownian motion component
hyp <- paste("sd_family__Intercept^2 /", "(sd_family__Intercept^2 + sd_family_name__Intercept^2) = 0")
(hyp <- hypothesis(fit_inv, hyp, class = NULL))

```